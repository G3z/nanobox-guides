# Add a Database

## Configure
You can add a database to your app by simply adding a data component to your `boxfile.yml`:

<div class="meta" data-class="snippet" data-optional-components="postgres,mysql,mongo" ></div>

In the above snippet `db` is the `NAME` of this component, and can be anything you choose as long as it is unique.

Nanobox generates the following environment variables based off that name:

* `DATA_DB_HOST` : autogenerated unique host ip
* `DATA_DB_USER` : user to connect with
* `DATA_DB_PASS` : unique password

**HEADS UP**: Your database will be provisioned and running the next time you `nanobox run`.

## Connect
A basic database setup needs at least a `Rakefile`, `config/database.yml`, and `config/environments.rb`.

The `Rakefile` should look something like this:

<div class="meta" data-class="configFile" data-run="Rakefile"></div>

```rake
require 'sinatra/activerecord'
require 'sinatra/activerecord/rake'
require './app'
```

The `config/database.yml` should look something like this:

<div class="meta" data-class="configFile" data-run="config/database.yml"></div>

```yaml
default: &default
  adapter: postgresql
  encoding: unicode
  pool: 2
  database: gonano
  host: <%= ENV['DATA_DB_HOST'] %>
  username: <%= ENV['DATA_DB_USER'] %>
  password: <%= ENV['DATA_DB_PASS'] %>

development:
  <<: *default

production:
  <<: *default
```

**HEADS UP**: Any database created by nanobox will *always* be named `gonano`

The `config/environments.rb` file should look something like this:

<div class="meta" data-class="configFile" data-run="config/environments.rb"></div>

```ruby
require 'sinatra/activerecord'

#The environment variable DATABASE_URL should be in the following format:
# => postgres://{user}:{password}@{host}:{port}/path
configure :production, :development do
  db = URI.parse(ENV['DATABASE_URL'] || "postgres://#{ENV['DATA_DB_USER']}:#{ENV['DATA_DB_PASS']}@#{ENV['DATA_DB_HOST']}/gonano")

  ActiveRecord::Base.establish_connection(
    :adapter  => db.scheme == 'postgres' ? 'postgresql' : db.scheme,
    :host     => db.host,
    :username => db.user,
    :password => db.password,
    :database => db.path[1..-1],
    :encoding => 'utf8'
  )
end
```

Finally, modify your app to include the `config/environments.rb`:

```ruby
require 'sinatra'
require './config/environments'
```

#### Update dependencies
Make sure your `Gemfile` has all the necessary dependencies for the database you're using. This example uses postgres and includes the following gems in the `Gemfile`:

```ruby
gem "activerecord"
gem "sinatra-activerecord"
gem "rake"
gem "pg"
```

Make sure to run `nanobox run bundle install` to install any new gems.

**HEADS UP**: This may take a little extra time as it's likely going to be provisioning your database as well.

## Test

#### From an external client
You can connect directly to your database from an <a href="https://docs.nanobox.io/local-dev/managing-local-data/" target="\_blank">external client</a>.

#### From Sinatra
Your can also test the connection with rake:

```bash
nanobox run bundle exec rake db:create
```

You'll see that your database has already been created and is ready to use!

## Now what?
Whats next? Think about what else your app might need and hopefully the topics below will help you get started with the next steps of your development!

* [Frontend Javascript](/ruby/sinatra/frontend-javascript)
* [Local Environment Variables](/ruby/sinatra/local-evars)
* [Back to Sinatra overview](/ruby/sinatra)
